{% extends 'base.html' %}
{% load static %}

{% block title %}{{ room_name }} | Chat App{% endblock %}

{% block extra_css %}
<style>
  .message-container {
    height: 65vh;
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }
  .message-container::-webkit-scrollbar {
    width: 6px;
  }
  .message-container::-webkit-scrollbar-track {
    background: transparent;
  }
  .message-container::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }
  @keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0; }
    100% { opacity: 1; }
  }
  .recording-indicator {
    animation: blink 1s infinite;
  }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-md overflow-hidden">
    <!-- Chat Header -->
    <div class="bg-indigo-50 p-4 border-b border-gray-200 flex justify-between items-center">
      <div class="flex items-center">
        {% if room.is_group %}
          <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-users text-indigo-500"></i>
          </div>
        {% else %}
          <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-user text-gray-500"></i>
          </div>
        {% endif %}
        <div>
          <h2 class="text-lg font-semibold text-gray-800">{{ room_name }}</h2>
          <p class="text-sm text-gray-500">
            {% if room.is_group %}
              {{ room.users.count }} members
            {% else %}
              Active now
            {% endif %}
          </p>
        </div>
      </div>
      <a href="{% url 'index' %}" class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-full transition">
        <i class="fas fa-times"></i>
      </a>
    </div>
    
    <!-- Messages Container -->
    <div class="p-4 bg-gray-50 message-container" id="message-container">
      {% for message in messages %}
        <div class="mb-4 {% if message.sender == request.user %}flex flex-row-reverse{% else %}flex{% endif %}">
          <div class="{% if message.sender == request.user %}bg-indigo-500 text-white rounded-tl-xl rounded-tr-xl rounded-bl-xl{% else %}bg-white border border-gray-200 rounded-tr-xl rounded-tl-xl rounded-br-xl{% endif %} px-4 py-2 max-w-xs sm:max-w-md shadow-sm">
            {% if message.message_type == 'text' %}
              <p class="text-sm">{{ message.content }}</p>
            {% elif message.message_type == 'audio' %}
              <div class="flex items-center justify-center w-full">
                <audio src="{{ message.file.url }}" controls class="w-full max-w-xs"></audio>
              </div>
            {% elif message.message_type == 'file' %}
              <a href="{{ message.file.url }}" target="_blank" class="flex items-center text-sm {% if message.sender == request.user %}text-indigo-100 hover:text-white{% else %}text-indigo-500 hover:text-indigo-700{% endif %} transition">
                <i class="fas fa-download mr-2"></i> Download File
              </a>
            {% endif %}
            
            <div class="flex justify-between items-center mt-1 text-xs {% if message.sender == request.user %}text-indigo-100{% else %}text-gray-500{% endif %}">
              <span>{{ message.sender.username }}</span>
              <span>{{ message.timestamp|date:"H:i" }}</span>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
    
    <!-- Message Input -->
    <div class="p-4 bg-white border-t border-gray-200">
      <div class="flex items-end space-x-2">
        <div class="flex-grow">
          <input type="text" id="message-input" placeholder="Type a message..." 
                 class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <button id="audio-record-btn" class="p-2 text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition">
          <i class="fas fa-microphone"></i>
        </button>
        <button id="send-btn" class="p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
      
      <!-- Audio Controls -->
      <div id="audio-controls" class="hidden mt-3 bg-indigo-50 p-2 rounded-lg">
        <div class="flex items-center">
          <span id="recording-indicator" class="recording-indicator flex items-center text-red-500 mr-2">
            <i class="fas fa-circle mr-1"></i> Recording...
          </span>
          <span id="recording-time" class="text-gray-600 mr-2">00:00</span>
          <button id="stop-recording-btn" class="px-3 py-1 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition">
            <i class="fas fa-stop mr-1"></i> Stop
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  let roomId = "{{ room.id }}";
  const currentUserId = {{ request.user.id }};
  const currentUsername = "{{ request.user.username }}";
  
  // Determine the protocol based on the current page protocol
  const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
  
  // WebSocket connection with dynamic protocol (wss:// or ws://)
  const chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + roomId + '/');
  
  // Messages container
  const messageContainer = document.getElementById('message-container');
  const messageInput = document.getElementById('message-input');
  const sendButton = document.getElementById('send-btn');
  
  // Scroll to bottom of message container
  function scrollToBottom() {
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }
  
  // Scroll to bottom initially
  scrollToBottom();
  
  // Add a message to the UI
  function addMessage(message, messageType, username, userId, timestamp, fileUrl = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-4 ' + (userId == currentUserId ? 'flex flex-row-reverse' : 'flex');
    
    const messageBubble = document.createElement('div');
    messageBubble.className = userId == currentUserId 
      ? 'bg-indigo-500 text-white rounded-tl-xl rounded-tr-xl rounded-bl-xl px-4 py-2 max-w-xs sm:max-w-md shadow-sm' 
      : 'bg-white border border-gray-200 rounded-tr-xl rounded-tl-xl rounded-br-xl px-4 py-2 max-w-xs sm:max-w-md shadow-sm';
    
    if (messageType === 'text') {
      const messageText = document.createElement('p');
      messageText.className = 'text-sm';
      messageText.textContent = message;
      messageBubble.appendChild(messageText);
    } else if (messageType === 'audio') {
      const audioContainer = document.createElement('div');
      audioContainer.className = 'flex items-center justify-center w-full';
      
      const audio = document.createElement('audio');
      audio.src = fileUrl;
      audio.controls = true;
      audio.className = 'w-full max-w-xs';
      
      audioContainer.appendChild(audio);
      messageBubble.appendChild(audioContainer);
    } else if (messageType === 'file') {
      const link = document.createElement('a');
      link.href = fileUrl;
      link.target = '_blank';
      link.className = 'flex items-center text-sm ' + (userId == currentUserId ? 'text-indigo-100 hover:text-white' : 'text-indigo-500 hover:text-indigo-700') + ' transition';
      
      const icon = document.createElement('i');
      icon.className = 'fas fa-download mr-2';
      
      link.appendChild(icon);
      link.appendChild(document.createTextNode('Download File'));
      messageBubble.appendChild(link);
    }
    
    const messageInfo = document.createElement('div');
    messageInfo.className = 'flex justify-between items-center mt-1 text-xs ' + (userId == currentUserId ? 'text-indigo-100' : 'text-gray-500');
    
    const usernameSpan = document.createElement('span');
    usernameSpan.textContent = username;
    
    const timeSpan = document.createElement('span');
    const date = new Date(timestamp);
    timeSpan.textContent = date.getHours().toString().padStart(2, '0') + ':' + 
                          date.getMinutes().toString().padStart(2, '0');
    
    messageInfo.appendChild(usernameSpan);
    messageInfo.appendChild(timeSpan);
    
    messageBubble.appendChild(messageInfo);
    messageDiv.appendChild(messageBubble);
    
    messageContainer.appendChild(messageDiv);
    scrollToBottom();
  }
  
  // Send message function
  function sendMessage() {
    const message = messageInput.value.trim();
    if (message) {
      chatSocket.send(JSON.stringify({
        'message': message,
        'type': 'text'
      }));
      messageInput.value = '';
    }
  }
  
  // Event listeners
  messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
  
  sendButton.addEventListener('click', sendMessage);
  
  // WebSocket event listeners
  chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    addMessage(
      data.message, 
      data.message_type, 
      data.username, 
      data.user_id, 
      data.timestamp,
      data.file_url
    );
  };
  
  chatSocket.onclose = function(e) {
    console.error('Chat socket closed unexpectedly');
  };
</script>
<script src="{% static 'js/audio.js' %}"></script>
{% endblock %}
{% endblock %}